 <html>
    <head>
        <title>M93 messenger</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    </head>
    <body class="h-100">

        <div class="container-fluid p-0" style="min-height: 100vh; ">
            <div class="row h-100" >
                <div class="col-2 ">
                    <ul id="chats">
                        {% comment %} <li>user1</li>
                        <li>user2</li>
                        <li>user3</li> {% endcomment %}
                    </ul>
                </div>
                <div class="col-10 bg-danger">
                    <p>Chat with <span id='current_chat'></span></p>
                    <ul id="messages">

                    </ul> 
                    <div id='input-message' style="position: absolute; bottom: 0" class='pb-3'>
                        <input id='msg-content'/>
                        <button onclick='handleCreateNewMessage(this)'>Send message</button>
                    </div>
                    
                </div>
            </div>
        </div>

        <script>

            $( document ).ready(function() {
                var current_chat_username;
                get_all_chat()
            });
            
        </script>


        <script>

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                }

            function get_token(username, password) {
                fetch("http://localhost:8000/get_token/", {
                    method: 'POST',
                    headers: {
                         'Content-Type': 'application/json',
                         'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                }).then(response => {
                    return response.json()
                }).then(result=>{
                    console.log("Result: message:", result)
                    localStorage.setItem('token', result.token)
                }).catch(err=>{
                    console.log("Err:", err)
                })
            }

            function handleChatChange(chat){
                current_chat_username = chat;
                document.getElementById('current_chat').innerHTML = current_chat_username;
                get_all_chat_with(2);
            }

            function showChatUsername(username_list){
                const ulElem = document.getElementById('chats');
                for (var username of username_list){
                    const liElem = document.createElement('li')
                    liElem.innerHTML = username;
                    liElem.setAttribute('username', username)
                    liElem.onclick = (e)=>{handleChatChange(e.target.getAttribute('username'))};
                    ulElem.appendChild(liElem);
                }
            }

            function showChatMessages(messages){
                const ulElem = document.getElementById('messages');
                ulElem.innerHTML = "";
                for (var message of messages){
                    const liElem = document.createElement('li')
                    liElem.innerHTML = message.subject + ':' + message.content;
                    ulElem.appendChild(liElem);
                }
            }


            function get_all_chat_with(receiver_id) {
                const token = localStorage.getItem('token');
                console.log("Token", token)
                if (!token) return;

                fetch("http://localhost:8000/chat/"+String(receiver_id)+'/',{
                    headers: {
                        'Authorization': "Token "+token
                    }
                }).then(response => {
                    console.log("Result: get all chat:", response)
                    return response.json()
                }).then(result=>{
                    console.log("Result: get all chat with "+receiver_id, result)
                    showChatMessages(result)
                }).catch(err=>{
                    console.log("Err:", err)
                })
            }

            function get_all_chat() {
                const token = localStorage.getItem('token');
                console.log("Token", token)
                if (!token) return;

                fetch("http://localhost:8000/chat/",{
                    headers: {
                        'Authorization': "Token "+token
                    }
                }).then(response => {
                    console.log("Result: get all chat:", response)
                    return response.json()
                }).then(result=>{
                    console.log("Result: get all chat:", result)
                    showChatUsername(result.data)
                }).catch(err=>{
                    console.log("Err:", err)
                })
            }

            function handleCreateNewMessage(e) {
                const msgElem = document.getElementById('msg-content');
                const content = msgElem.value;
                create_new_message('', content);
            }

            function create_new_message(subject, content) {
                const token = localStorage.getItem('token');
                console.log("Token", token)
                if (!token) return;

                const receiver_id = 2;
                fetch("http://localhost:8000/chat/"+receiver_id+'/create/',{
                    method: 'POST',
                    headers: {
                        'Authorization': "Token "+token
                    },
                    body: JSON.stringify({
                        subject: subject,
                        content: content
                    })
                }).then(response => {
                    console.log("Result: create result:", response)
                    return response.json()
                }).then(result=>{
                    console.log("Result: get all chat:", result)
                    get_all_chat_with(receiver_id);
                }).catch(err=>{
                    console.log("Err:", err)
                })
            }

        </script>
    </body>
    <footer>
        
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    </footer>
 </html>
